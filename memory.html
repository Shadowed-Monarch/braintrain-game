<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Memory Matrix</title>
    <script src="theme.js"></script>
    <style>
        @property --accent { syntax: '<color>'; initial-value: #f00; inherits: true; }
        :root[data-theme="dark"] { --bg: #050505; --text: #fff; --border: #333; --overlay: rgba(0,0,0,0.9); --shadow-color: var(--accent); }
        :root[data-theme="light"] { --bg: #f5f5f5; --text: #000; --border: #ddd; --overlay: rgba(255,255,255,0.9); --shadow-color: transparent; }
        @keyframes rainbow-loop { 0%{--accent:#f00} 20%{--accent:#ff0} 40%{--accent:#0f0} 60%{--accent:#0ff} 80%{--accent:#90f} 100%{--accent:#f00} }
        .rainbow-active { animation: rainbow-loop 5s infinite linear !important; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; touch-action: none; }
        header { width: 100%; padding: 10px 20px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--accent); align-items: center; background: var(--bg); box-sizing: border-box; flex-shrink: 0; }
        .brain-wrap { display: flex; align-items: center; gap: 8px; color: #ff77ff; font-weight: bold; }
        #game-container { position: relative; width: 90vmin; height: 90vmin; max-width: 400px; max-height: 400px; margin-top: 20px; display: grid; gap: 8px; border: 1px solid var(--border); padding: 10px; border-radius: 10px; box-sizing: border-box; }
        .block { background: var(--border); border-radius: 8px; cursor: pointer; transition: background 0.2s, box-shadow 0.2s; }
        .block.glow { background: var(--accent); box-shadow: 0 0 15px var(--accent); }
        .block.correct { background: #00ff00; box-shadow: 0 0 15px #00ff00; }
        .block.wrong { background: #ff0000; box-shadow: 0 0 15px #ff0000; }
        .game-btn { padding: 12px 30px; font-size: 1.2rem; background: var(--bg); color: var(--text); border: 2px solid var(--accent); border-radius: 30px; cursor: pointer; margin-top: 20px; flex-shrink: 0; }
        #btn-container { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: var(--overlay); z-index: 20; text-align: center; padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" style="text-decoration:none; color:var(--text); font-weight:bold;">‚Üê HOME</a>
        <div style="font-weight:bold;">LEVEL <span id="lvl-display">1</span></div>
        <div class="brain-wrap"><span>üß†</span> <span id="total-brains">0</span></div>
    </header>
    <div id="game-container">
        <div id="btn-container"><h1 id="m-title" style="font-size:1.8rem;"></h1></div>
    </div>
    <button id="main-start-btn" class="game-btn" onclick="game.start()">START GAME</button>
    <script>
        let selectedLvl = parseInt(localStorage.getItem('bt_unlocked_memory')) || 1;
        class MemoryGame {
            constructor() {
                this.brains = parseInt(localStorage.getItem('bt_coins')) || 0;
                this.isPlaying = false;
                this.sequence = [];
                this.userClicks = 0;
                this.updateUI();
            }
            updateUI() {
                document.getElementById('total-brains').innerText = this.brains;
                document.getElementById('lvl-display').innerText = selectedLvl;
            }
            start() {
                document.getElementById('main-start-btn').style.display = 'none';
                document.getElementById('btn-container').style.display = 'none';
                this.isPlaying = true;
                this.userClicks = 0;
                this.sequence = [];
                this.setupGrid();
            }
            setupGrid() {
                const container = document.getElementById('game-container');
                container.innerHTML = '<div id="btn-container"><h1 id="m-title" style="font-size:1.8rem;"></h1></div>';
                let gridSize = 3 + Math.floor((selectedLvl - 1) / 3);
                gridSize = Math.min(gridSize, 6); 
                container.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
                let totalBlocks = gridSize * gridSize;
                let blocksToRemember = 3 + Math.floor(selectedLvl / 2);
                for (let i = 0; i < totalBlocks; i++) {
                    const block = document.createElement('div');
                    block.className = 'block';
                    block.dataset.id = i;
                    container.appendChild(block);
                }
                const allIndices = Array.from({length: totalBlocks}, (_, i) => i);
                this.sequence = allIndices.sort(() => 0.5 - Math.random()).slice(0, blocksToRemember);
                setTimeout(() => {
                    this.sequence.forEach(id => {
                        container.children[id + 1].classList.add('glow');
                    });
                    setTimeout(() => {
                        this.sequence.forEach(id => {
                            container.children[id + 1].classList.remove('glow');
                        });
                        this.enableUserClicks();
                    }, 2500);
                }, 500);
            }
            enableUserClicks() {
                const blocks = document.querySelectorAll('.block');
                blocks.forEach(block => {
                    const handleInput = (e) => {
                        if (e) e.preventDefault();
                        if (!this.isPlaying) return;
                        const id = parseInt(block.dataset.id);
                        if (this.sequence.includes(id)) {
                            if (!block.classList.contains('correct')) {
                                block.classList.add('correct');
                                this.userClicks++;
                                if (this.userClicks === this.sequence.length) this.end("win");
                            }
                        } else {
                            block.classList.add('wrong');
                            this.end("fail");
                        }
                    };
                    block.onpointerdown = handleInput;
                });
            }
            end(result) {
                this.isPlaying = false;
                const title = document.getElementById('m-title');
                const btnContainer = document.getElementById('btn-container');
                btnContainer.innerHTML = `<h1 id="m-title" style="font-size:1.8rem;"></h1>`;
                const newTitle = btnContainer.querySelector('#m-title');
                btnContainer.style.display = 'flex';
                if (result === "win") {
                    this.brains += (selectedLvl * 5);
                    if (selectedLvl === (parseInt(localStorage.getItem('bt_unlocked_memory')) || 1)) {
                        localStorage.setItem('bt_unlocked_memory', selectedLvl + 1);
                    }
                    localStorage.setItem('bt_coins', this.brains);
                    newTitle.innerText = "LEVEL CLEAR!";
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'game-btn';
                    nextBtn.innerText = "NEXT LEVEL";
                    nextBtn.onclick = () => { selectedLvl++; this.updateUI(); this.start(); };
                    btnContainer.appendChild(nextBtn);
                } else {
                    newTitle.innerText = "YOU CAN'T DO THIS LEVEL üíÄ";
                    const retryBtn = document.createElement('button');
                    retryBtn.className = 'game-btn';
                    retryBtn.innerText = "PLAY AGAIN";
                    retryBtn.onclick = () => this.start();
                    btnContainer.appendChild(retryBtn);
                }
                this.updateUI();
            }
        }
        const game = new MemoryGame();
    </script>
</body>
</html>
