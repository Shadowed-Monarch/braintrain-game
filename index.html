<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Trainer Pro</title>
    <style>
        :root {
            --bg:#000;
            --accent:#e74c3c;
            --panel:#1a1a1a;
            --text:#fff;
            --gold:#f1c40f;
        }
        * { box-sizing: border-box; }
        body { margin:0; font-family:'Segoe UI',Arial,sans-serif; background:var(--bg); color:var(--text); display:flex; flex-direction:column; min-height:100vh; overflow: hidden;}
        header { background:#200; border-bottom:4px solid var(--accent); text-align:center; padding:10px; }
        button { background:#000; border:2px solid var(--accent); color:#fff; padding:8px 14px; margin:3px; border-radius:6px; font-weight:bold; cursor:pointer;}
        button:hover { background:var(--accent); }
        
        #hud { display:flex; justify-content:space-around; color:var(--accent); padding:6px; font-size:1.1rem; }
        #game { flex:1; margin:8px; border:3px solid var(--accent); border-radius:12px; background:var(--panel); position:relative; overflow:hidden; }
        
        .overlay { position:absolute; inset:0; background:rgba(0,0,0,.9); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:99; }
        .hidden { display:none !important; }
        
        input { padding:12px; font-size:1.2rem; border-radius:10px; border:2px solid var(--accent); background:#111; color:var(--accent); text-align:center; width:80%; max-width:400px; }
        
        .bubble { position:absolute; background:var(--accent); color:#fff; padding:10px 18px; border-radius:25px; font-weight:bold; white-space:nowrap; transition: top 0.2s; }
        .dot { width:60px; height:60px; border-radius:50%; background:var(--accent); color:#fff; display:flex; align-items:center; justify-content:center; font-size:1.5rem; font-weight:bold; border:3px solid #fff; position:absolute; cursor:pointer; }
        
        #leaderboardBox { position:absolute; top:10px; right:10px; background:rgba(17,17,17,0.8); padding:10px; border-radius:10px; border:1px solid var(--accent); max-width:150px; max-height:200px; overflow-y:auto; font-size: 0.8rem; pointer-events: none;}
        #inputArea { text-align:center; padding:15px; background: #000; }
        
        @media(max-width:600px){ 
            .dot { width:50px; height:50px; } 
            #leaderboardBox { display: none; }
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

<header>
    <h2>Brain Speed Trainer</h2>
    <div>
        <button onclick="game.switchGame('math')">MATH</button>
        <button onclick="game.switchGame('grammar')">GRAMMAR</button>
        <button onclick="game.switchGame('dots')">DOTS</button>
    </div>
</header>

<div id="hud">
    <span>LEVEL: <span id="lvlDisplay">1</span></span>
    <span id="timerContainer" class="hidden">TIME: <span id="timeDisplay">30</span></span>
</div>

<div id="game">
    <div id="nameBox" class="overlay">
        <h3 style="color:var(--gold)">ENTER YOUR NAME</h3>
        <input id="nameInput" maxlength="12" placeholder="Your Name...">
        <br>
        <button onclick="game.setName()">SAVE & START</button>
    </div>

    <div id="gameOverlay" class="overlay hidden">
        <h2 id="msgDisplay">READY?</h2>
        <button id="startBtn" onclick="game.start()">START LEVEL</button>
    </div>

    <div id="leaderboardBox">
        <h4 style="margin:0 0 5px 0; color:var(--gold)">Top Scores</h4>
        <ul id="leaderList" style="padding-left:16px;margin:0; list-style: none; padding:0;"></ul>
    </div>
</div>

<div id="inputArea" class="hidden">
    <input id="answerInput" placeholder="Type answer here..." autocomplete="off">
</div>

<script>
// Firebase config - REPLACE THESE WITH YOUR KEYS
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
};

// Initialize Firebase only if keys are provided
let db = null;
try {
    if(firebaseConfig.apiKey !== "YOUR_API_KEY") {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    }
} catch(e) { console.error("Firebase not connected"); }

// Placeholder Sounds (Silent Data URIs)
const sndCorrect = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQgAAAAA");
const sndWrong = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQgAAAAA");

class BrainGame {
    constructor() {
        this.name = localStorage.getItem("bt_name") || "";
        this.level = 1;
        this.mode = null;
        this.activeBubbles = [];
        this.isPlaying = false;
        this.spawnTimer = null;
        this.updateTimer = null;
        this.clockTimer = null;
        this.count = 0;
        
        this.grammarPool = [
            {q:"Happy (opp.)",a:"sad"},{q:"Fast (opp.)",a:"slow"},{q:"Big (opp.)",a:"small"},
            {q:"Hot (opp.)",a:"cold"},{q:"Color: Sky",a:"blue"},{q:"Color: Grass",a:"green"},
            {q:"Go (past)",a:"went"},{q:"Eat (past)",a:"ate"},{q:"Run (past)",a:"ran"},
            {q:"Read (past)",a:"read"},{q:"I ___ to school",a:"went"},{q:"She ___ an apple",a:"ate"}
        ];

        if(this.name) {
            document.getElementById("nameBox").classList.add("hidden");
            this.updateLeaderboard();
        }
    }

    setName() {
        const val = document.getElementById("nameInput").value.trim();
        if(val.length > 1) {
            this.name = val;
            localStorage.setItem("bt_name", val);
            document.getElementById("nameBox").classList.add("hidden");
            this.updateLeaderboard();
        }
    }

    switchGame(mode) {
        this.stop();
        this.mode = mode;
        this.level = 1;
        document.getElementById("lvlDisplay").innerText = this.level;
        document.getElementById("gameOverlay").classList.remove("hidden");
        document.getElementById("msgDisplay").innerText = `${mode.toUpperCase()} MODE`;
        document.getElementById("startBtn").innerText = "START";
    }

    start() {
        this.stop();
        this.isPlaying = true;
        this.count = 0;
        this.activeBubbles = [];
        document.getElementById("gameOverlay").classList.add("hidden");
        document.getElementById("lvlDisplay").innerText = this.level;

        if(this.mode === 'dots') {
            this.startDots();
        } else {
            document.getElementById("inputArea").classList.remove("hidden");
            document.getElementById("answerInput").focus();
            // Start spawning
            this.spawnTimer = setInterval(() => this.spawn(), Math.max(800, 3000 - (this.level * 250)));
            // Start moving
            this.updateTimer = setInterval(() => this.updateLogic(), 16);
        }
    }

    stop() {
        this.isPlaying = false;
        clearInterval(this.spawnTimer);
        clearInterval(this.updateTimer);
        clearInterval(this.clockTimer);
        document.getElementById("game").querySelectorAll(".bubble, .dot").forEach(e => e.remove());
        document.getElementById("inputArea").classList.add("hidden");
        document.getElementById("timerContainer").classList.add("hidden");
        document.getElementById("answerInput").value = "";
    }

    spawn() {
        if(!this.isPlaying || this.count >= 10) return;

        let q, a;
        if(this.mode === "grammar") {
            let item = this.grammarPool[Math.floor(Math.random() * this.grammarPool.length)];
            q = item.q; a = item.a;
        } else {
            let x = Math.floor(Math.random() * (10 + this.level));
            let y = Math.floor(Math.random() * 10);
            q = `${x} + ${y}`; a = `${x + y}`;
        }

        const el = document.createElement("div");
        el.className = "bubble";
        el.innerText = q;
        el.style.top = Math.random() * (document.getElementById("game").clientHeight - 50) + "px";
        el.style.left = "-150px";
        document.getElementById("game").appendChild(el);

        this.activeBubbles.push({ el, x: -150, a: a.toLowerCase() });
        this.count++;
    }

    updateLogic() {
        if(!this.isPlaying) return;
        this.activeBubbles.forEach((obj, index) => {
            obj.x += (0.8 + (this.level * 0.3));
            obj.el.style.left = obj.x + "px";

            if(obj.x > document.getElementById("game").clientWidth) {
                this.lose();
            }
        });
    }

    checkAnswer(val) {
        if(!this.isPlaying) return;
        const index = this.activeBubbles.findIndex(b => b.a === val.toLowerCase().trim());
        if(index > -1) {
            sndCorrect.play();
            this.activeBubbles[index].el.remove();
            this.activeBubbles.splice(index, 1);
            document.getElementById("answerInput").value = "";
            
            if(this.count >= 10 && this.activeBubbles.length === 0) {
                this.win();
            }
        }
    }

startDots() {
    document.getElementById("timerContainer").classList.remove("hidden");
    let currentDot = 1;
    let totalDots = 5 + Math.floor(this.level / 1.5);
    let timeLeft = 30;
    const dotRadius = 70; // Minimum distance between dots
    const placedDots = [];
    
    document.getElementById("timeDisplay").innerText = timeLeft;
    this.clockTimer = setInterval(() => {
      timeLeft--;
      document.getElementById("timeDisplay").innerText = timeLeft;
      if(timeLeft <= 0) this.lose();
    }, 1000);

    for(let i=1; i<=totalDots; i++){
      const d = document.createElement("div");
      d.className = "dot";
      d.innerText = i;
      // Ensure lower numbers have higher z-index so they aren't hidden
      d.style.zIndex = 100 - i; 

      let x, y, overlap;
      let attempts = 0;

      // Anti-Overlay Logic: Keep looking for a spot until no overlap
      do {
        overlap = false;
        x = Math.random() * (document.getElementById("game").clientWidth - 70);
        y = Math.random() * (document.getElementById("game").clientHeight - 70);
        attempts++;

        for (let pos of placedDots) {
          const distance = Math.sqrt(Math.pow(x - pos.x, 2) + Math.pow(y - pos.y, 2));
          if (distance < dotRadius) {
            overlap = true;
            break;
          }
        }
        // Safety break to prevent infinite loops if screen is too full
      } while (overlap && attempts < 100);

      placedDots.push({x, y});
      d.style.left = x + "px";
      d.style.top = y + "px";

      d.onclick = () => {
        if(i === currentDot) {
          d.remove();
          currentDot++;
          if(currentDot > totalDots) this.win();
        } else {
          this.lose();
        }
      };
      document.getElementById("game").appendChild(d);
    }
  }
    win() {
        this.stop();
        this.level++;
        this.submitScore();
        document.getElementById("gameOverlay").classList.remove("hidden");
        document.getElementById("msgDisplay").innerText = "LEVEL CLEAR!";
        document.getElementById("startBtn").innerText = "NEXT LEVEL";
    }

    lose() {
        sndWrong.play();
        this.stop();
        document.getElementById("gameOverlay").classList.remove("hidden");
        document.getElementById("msgDisplay").innerText = "GAME OVER";
        document.getElementById("startBtn").innerText = "TRY AGAIN";
        this.level = 1;
    }

    submitScore() {
        if(!db || !this.name) return;
        db.ref('leaderboard').push({
            name: this.name,
            score: this.level,
            timestamp: Date.now()
        });
    }

    updateLeaderboard() {
        if(!db) return;
        db.ref('leaderboard').orderByChild('score').limitToLast(10).on('value', snap => {
            let list = [];
            snap.forEach(s => list.push(s.val()));
            list.sort((a,b) => b.score - a.score);
            const html = list.map(i => `<li>${i.name}: Lvl ${i.score}</li>`).join('');
            document.getElementById("leaderList").innerHTML = html;
        });
    }
}

const game = new BrainGame();

// Global Listeners
document.getElementById("answerInput").addEventListener("input", (e) => {
    game.checkAnswer(e.target.value);
});
</script>

</body>
</html>

