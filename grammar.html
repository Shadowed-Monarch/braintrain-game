<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grammar Training</title>
    <style>
        :root { --bg: #000; --accent: #ff0000; --text: #fff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        header { width: 100%; padding: 10px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--accent); align-items: center; box-sizing: border-box;}
        .back-btn { text-decoration: none; color: white; font-weight: bold; border: 1px solid white; padding: 5px 10px; border-radius: 5px; }
        
        /* Level Selector Grid */
        #level-menu { width: 95%; max-width: 800px; height: 80vh; overflow-y: auto; margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .lvl-btn { 
            width: 60px; height: 60px; background: #222; border: 2px solid #444; color: #fff; 
            font-size: 1.2rem; font-weight: bold; cursor: pointer; border-radius: 10px;
        }
        .lvl-btn.unlocked { border-color: var(--accent); background: #111; }
        .lvl-btn.unlocked:hover { background: var(--accent); }
        .lvl-btn.locked { opacity: 0.5; cursor: not-allowed; }

        /* Game Area */
        #game-ui { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; }
        #game-container { position: relative; width: 95%; max-width: 850px; height: 400px; background: #111; border: 3px solid var(--accent); border-radius: 10px; overflow: hidden; margin-top: 20px; }
        .question-bubble { position: absolute; background: var(--accent); color: white; padding: 10px 18px; border-radius: 20px; font-weight: bold; white-space: nowrap; z-index: 5; }
        
        #input-area { width: 100%; margin-top: 15px; text-align: center; }
        input { padding: 12px; font-size: 1.2rem; width: 80%; max-width: 350px; background: #222; color: var(--accent); border: 2px solid var(--accent); border-radius: 8px; outline: none; }
        
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #overlay button { background: var(--bg); color: white; border: 2px solid var(--accent); padding: 12px 30px; font-size: 1.1rem; cursor: pointer; border-radius: 8px; margin: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="back-btn">â¬… HOME</a>
        <div id="status-bar">Lvl: <span id="current-lvl-display">-</span> | ðŸª™ <span id="coin-display">0</span></div>
    </header>

    <div id="level-menu">
        </div>

    <div id="game-ui">
        <div id="game-container">
            <div id="overlay" class="hidden">
                <h2 id="title">READY?</h2>
                <button onclick="game.startLevel()">START</button>
                <button onclick="game.exitToMenu()" style="font-size:0.8rem; border-color:#555;">Quit to Menu</button>
            </div>
        </div>
        <div id="input-area"><input type="text" id="ans" placeholder="Type answer..." autocomplete="off"></div>
    </div>

    <script>
        class GrammarGame {
            constructor() {
                this.maxLevel = parseInt(localStorage.getItem('bt_grammar_max_lvl')) || 1;
                this.coins = parseInt(localStorage.getItem('bt_coins')) || 0;
                this.currentSkin = localStorage.getItem('bt_current_skin') || 'red';
                
                this.activeLevel = 1;
                this.isPlaying = false;
                this.active = [];
                this.count = 0;
                
                // Question Bank
                this.bank = [
                    {q:"Opposite: Hot", a:["cold"]}, {q:"Opposite: Big", a:["small", "tiny"]}, 
                    {q:"Opposite: Up", a:["down"]}, {q:"Opposite: Left", a:["right"]},
                    {q:"Synonym: Fast", a:["quick", "rapid"]}, {q:"Synonym: Happy", a:["glad", "joyful"]},
                    {q:"Past: Eat", a:["ate"]}, {q:"Past: Run", a:["ran"]}, {q:"Past: Go", a:["went"]},
                    {q:"Color: Banana", a:["yellow"]}, {q:"Color: Grass", a:["green"]}, {q:"Color: Sky", a:["blue"]}
                ];

                this.applySkin();
                this.renderMenu();
                this.updateHud();
            }

            applySkin() {
                const colors = { red:'#ff0000', blue:'#0088ff', yellow:'#ffcc00', green:'#00ff00', purple:'#9900ff', cyan:'#00ffff' };
                if(this.currentSkin === 'rainbow') {
                    document.documentElement.style.setProperty('--accent', 'white');
                } else {
                    document.documentElement.style.setProperty('--accent', colors[this.currentSkin] || '#ff0000');
                }
            }

            renderMenu() {
                const menu = document.getElementById('level-menu');
                menu.innerHTML = '';
                for(let i = 1; i <= this.maxLevel + 1; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'lvl-btn';
                    btn.innerText = i;
                    if(i <= this.maxLevel) {
                        btn.classList.add('unlocked');
                        btn.onclick = () => this.selectLevel(i);
                    } else {
                        btn.classList.add('locked');
                    }
                    menu.appendChild(btn);
                }
            }

            selectLevel(lvl) {
                this.activeLevel = lvl;
                document.getElementById('level-menu').style.display = 'none';
                document.getElementById('game-ui').style.display = 'flex';
                document.getElementById('current-lvl-display').innerText = lvl;
                document.getElementById('overlay').classList.remove('hidden');
                document.getElementById('title').innerText = `LEVEL ${lvl}`;
                document.getElementById('ans').value = '';
            }

            exitToMenu() {
                this.isPlaying = false;
                clearInterval(this.spawnInt);
                document.getElementById('game-ui').style.display = 'none';
                document.getElementById('level-menu').style.display = 'flex';
                this.renderMenu();
            }

            startLevel() {
                this.isPlaying = true;
                this.count = 0;
                this.active = [];
                document.getElementById('overlay').classList.add('hidden');
                document.getElementById('game-container').querySelectorAll('.question-bubble').forEach(e => e.remove());
                document.getElementById('ans').focus();
                
                this.loop();
                let spawnRate = Math.max(1000, 3000 - (this.activeLevel * 100));
                this.spawnInt = setInterval(() => this.spawn(), spawnRate);
            }

            spawn() {
                if(!this.isPlaying || this.count + this.active.length >= 10) return;
                
                const data = this.bank[Math.floor(Math.random() * this.bank.length)];
                
                const el = document.createElement('div');
                el.className = 'question-bubble';
                el.innerText = data.q;
                el.style.top = (Math.random() * 300 + 30) + 'px';
                if(this.currentSkin === 'rainbow') el.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                
                document.getElementById('game-container').appendChild(el);
                
                // SPEED: Base 0.5 + (Level * 0.15)
                let speed = 0.5 + (this.activeLevel * 0.15);
                
                this.active.push({ el, x: -150, speed, a: data.a });
            }

            loop() {
                if(!this.isPlaying) return;
                this.active.forEach((ent, i) => {
                    ent.x += ent.speed;
                    ent.el.style.transform = `translateX(${ent.x}px)`;
                    if(ent.x > 850) this.end('FAIL');
                });
                requestAnimationFrame(() => this.loop());
            }

            end(txt) {
                this.isPlaying = false;
                clearInterval(this.spawnInt);
                document.getElementById('overlay').classList.remove('hidden');
                document.getElementById('title').innerText = txt;
                
                if(txt === 'SUCCESS') {
                    if(this.activeLevel === this.maxLevel) {
                        this.maxLevel++;
                        localStorage.setItem('bt_grammar_max_lvl', this.maxLevel);
                    }
                    
                    let reward = 10;
                    if(this.activeLevel === 1 && this.maxLevel === 2) reward = 100;
                    if(this.activeLevel % 10 === 0) reward = 100;
                    
                    this.coins += reward;
                    localStorage.setItem('bt_coins', this.coins);
                    this.updateHud();
                    
                    const btn = document.querySelector('#overlay button');
                    btn.innerText = "NEXT LEVEL";
                    btn.onclick = () => {
                        this.activeLevel++;
                        this.selectLevel(this.activeLevel);
                        setTimeout(() => this.startLevel(), 100);
                    };
                } else {
                    const btn = document.querySelector('#overlay button');
                    btn.innerText = "RETRY";
                    btn.onclick = () => this.startLevel();
                }
            }

            updateHud() {
                document.getElementById('coin-display').innerText = this.coins;
            }
        }

        const game = new GrammarGame();
        document.getElementById('ans').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase().trim();
            const idx = game.active.findIndex(ent => ent.a.includes(val));
            if(idx !== -1) {
                game.active[idx].el.remove();
                game.active.splice(idx, 1);
                e.target.value = '';
                game.count++;
                if(game.count >= 10) game.end('SUCCESS');
            }
        });
    </script>
</body>
</html>
